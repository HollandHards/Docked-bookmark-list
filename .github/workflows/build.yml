name: Attach Zips to Release

# Trigger ONLY when you click "Publish release" on the website
on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. GET VERSION FROM TAG (e.g., refs/tags/v1.6 -> 1.6)
      - name: Get Version
        id: get_version
        run: |
          # Strip 'refs/tags/v' from the tag name
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 2. BUILD CHROME
      - name: Build Chrome
        run: |
          mkdir -p dist/chrome
          cp -a src/. dist/chrome/
          rm dist/chrome/manifest-firefox.json
          mv dist/chrome/manifest-chrome.json dist/chrome/manifest.json
          cd dist/chrome
          zip -r ../../VerticalDock-Chrome-v${{ env.VERSION }}.zip .

      # 3. BUILD FIREFOX
      - name: Build Firefox
        run: |
          mkdir -p dist/firefox
          cp -a src/. dist/firefox/
          rm dist/firefox/manifest-chrome.json
          mv dist/firefox/manifest-firefox.json dist/firefox/manifest.json
          cd dist/firefox
          zip -r ../../VerticalDock-Firefox-v${{ env.VERSION }}.zip .

      # 4. UPLOAD TO THE RELEASE
      - name: Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            VerticalDock-Chrome-v${{ env.VERSION }}.zip
            VerticalDock-Firefox-v${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
