name: Build Extensions

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. GET VERSION
      - name: Extract Version
        id: get_version
        run: |
          VERSION=$(jq -r .version src/manifest-chrome.json)
          echo "Detected Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 2. DEBUG: Verify Source Files (Check logs if images are missing here)
      - name: List Source Files
        run: ls -R src

      # ---------------------------------------------------------
      # 3. BUILD CHROME
      # ---------------------------------------------------------
      - name: Prepare Chrome Build
        run: |
          mkdir -p dist/chrome
          # safer copy command that includes everything
          cp -a src/. dist/chrome/
          
          # Clean up manifests
          rm dist/chrome/manifest-firefox.json
          mv dist/chrome/manifest-chrome.json dist/chrome/manifest.json
          
          # DEBUG: Verify Dist Content
          echo "Contents of Chrome Build:"
          ls -la dist/chrome

      - name: Zip Chrome Extension
        run: |
          cd dist/chrome
          zip -r ../../VerticalDock-Chrome-v${{ env.VERSION }}.zip .

      # ---------------------------------------------------------
      # 4. BUILD FIREFOX
      # ---------------------------------------------------------
      - name: Prepare Firefox Build
        run: |
          mkdir -p dist/firefox
          cp -a src/. dist/firefox/
          
          # Clean up manifests
          rm dist/firefox/manifest-chrome.json
          mv dist/firefox/manifest-firefox.json dist/firefox/manifest.json

      - name: Zip Firefox Extension
        run: |
          cd dist/firefox
          zip -r ../../VerticalDock-Firefox-v${{ env.VERSION }}.zip .

      # ---------------------------------------------------------
      # 5. UPLOAD ARTIFACTS
      # ---------------------------------------------------------
      - name: Upload Chrome Build
        uses: actions/upload-artifact@v4
        with:
          name: VerticalDock-Chrome-v${{ env.VERSION }}
          path: VerticalDock-Chrome-v${{ env.VERSION }}.zip

      - name: Upload Firefox Build
        uses: actions/upload-artifact@v4
        with:
          name: VerticalDock-Firefox-v${{ env.VERSION }}
          path: VerticalDock-Firefox-v${{ env.VERSION }}.zip
