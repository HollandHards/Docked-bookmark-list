name: Publish Release

on:
  push:
    tags:
      - 'v*' # Triggers only when you push a tag like v1.6, v1.7, etc.

permissions:
  contents: write # Required to create a Release

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. GET VERSION FROM MANIFEST
      - name: Extract Version
        id: get_version
        run: |
          VERSION=$(jq -r .version src/manifest-chrome.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 2. BUILD CHROME
      - name: Build Chrome
        run: |
          mkdir -p dist/chrome
          cp -a src/. dist/chrome/
          rm dist/chrome/manifest-firefox.json
          mv dist/chrome/manifest-chrome.json dist/chrome/manifest.json
          cd dist/chrome
          zip -r ../../VerticalDock-Chrome-v${{ env.VERSION }}.zip .

      # 3. BUILD FIREFOX
      - name: Build Firefox
        run: |
          mkdir -p dist/firefox
          cp -a src/. dist/firefox/
          rm dist/firefox/manifest-chrome.json
          mv dist/firefox/manifest-firefox.json dist/firefox/manifest.json
          cd dist/firefox
          zip -r ../../VerticalDock-Firefox-v${{ env.VERSION }}.zip .

      # 4. CREATE PUBLIC RELEASE
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            VerticalDock-Chrome-v${{ env.VERSION }}.zip
            VerticalDock-Firefox-v${{ env.VERSION }}.zip
          name: Release v${{ env.VERSION }}
          body: |
            ## Vertical Bookmark Dock v${{ env.VERSION }}
            
            **Changes in this version:**
            - Auto-generated release.
            
            **Installation:**
            - **Chrome:** Download the Chrome zip, unzip it, and load unpacked in `chrome://extensions`.
            - **Firefox:** Download the Firefox zip and load it in `about:debugging`.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
